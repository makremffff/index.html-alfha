ÿ∑<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SHIB Ads WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* ŸÉŸÑ ÿßŸÑÿ≥ÿ™ÿßŸäŸÑÿßÿ™ ŸÉŸÖÿß ŸáŸä ÿØŸàŸÜ ÿ™ÿ∫ŸäŸäÿ± */
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Vazirmatn', Arial, Helvetica, sans-serif;overflow:hidden;background:#fff}
    .loading-screen{position:fixed;inset:0;background:#0d0c1d;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;transition:opacity .5s ease-out}
    .loading-screen.hidden{opacity:0;pointer-events:none}
    .loading-content{text-align:center;color:#fff}
    .progress-container{width:300px;height:12px;background:rgba(255,255,255,.05);border-radius:10px;overflow:hidden;margin:2.5rem 0;box-shadow:0 0 15px rgba(0,255,255,0.4);border:2px solid #00ffff}
    .progress-bar{height:100%;background:linear-gradient(90deg, #00ffff 0%, #00bfff 100%);border-radius:8px;width:0;transition:width .4s ease;position:relative;overflow:hidden}
    .progress-bar::after{content:'';position:absolute;top:0;left:0;bottom:0;right:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent);animation:shimmer 1.5s infinite}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    .percentage{font-size:2.5rem;font-family:'Orbitron',sans-serif;color:#fff;margin-top:1rem;text-shadow:0 0 10px #00ffff,0 0 20px rgba(0,255,255,0.8);letter-spacing:2px}
    .loading-text{font-size:1.2rem;color:rgba(255,255,255,.9);margin-top:1rem;text-shadow:0 1px 2px rgba(0,0,0,.5);animation:pulse 1.5s infinite alternate}
    @keyframes pulse{0%{opacity:.7;transform:scale(1)}100%{opacity:1;transform:scale(1.05)}}
    .main-screen{position:fixed;inset:0;background:url('img.png') no-repeat center;background-size:cover;opacity:0;transition:opacity .5s ease-in;display:flex;flex-direction:column}
    .main-screen.visible{opacity:1}
    .main-content{flex:1;display:flex;justify-content:center;align-items:center}
    .user-circle{position:absolute;top:20px;left:20px;width:70px;height:70px;border:2px dashed #ccc;border-radius:50%;display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;transition:all .3s ease;z-index:100;overflow:hidden}
    .user-circle:hover{border-color:#4a90e2;background:rgba(74,144,226,.05)}
    .user-circle img{width:100%;height:100%;object-fit:cover;border-radius:50%;display:none}
    .user-circle .placeholder{color:#999;font-size:12px;text-align:center}
    .user-username{position:absolute;top:95px;left:20px;width:70px;font-size:13px;color:#555;white-space:nowrap;text-align:center;overflow:hidden;text-overflow:ellipsis}
    .user-id{position:absolute;top:115px;left:20px;width:70px;font-size:11px;color:#888;white-space:nowrap;text-align:center;overflow:hidden;text-overflow:ellipsis}
    .balance{position:absolute;top:20px;right:20px;background:#fff;border:1px solid #ff5a5a;border-radius:12px;padding:8px 12px;font-family:'Courier New',monospace;font-size:16px;color:#ff2a2a;text-shadow:0 0 2px #ffbbbb;letter-spacing:1px;z-index:101;box-shadow:0 4px 6px rgba(0,0,0,.05)}
    .progress-group-container{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;gap:20px;width:90%;max-width:300px;z-index:102}
    .daily-progress-container,.spin-progress-container{background:#fff;padding:15px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,.1);text-align:center;border-left:5px solid #4a90e2}
    .spin-progress-container{border-left:5px solid #ff8c00}
    .daily-progress-text,.spin-progress-text{font-size:14px;color:#333;margin-bottom:4px;font-weight:bold}
    .daily-progress-bar,.spin-progress-bar{width:100%;height:12px;background:rgba(0,0,0,.1);border-radius:10px;overflow:hidden;margin-top:6px}
    .daily-progress-fill{background:linear-gradient(90deg,#00f2fe,#4facfe);height:100%;border-radius:10px;width:0%;transition:width .4s ease}
    .spin-progress-fill{background:linear-gradient(90deg,#ff8c00,#ff4500);height:100%;border-radius:10px;width:0%;transition:width .4s ease}
    .button-container{position:absolute;bottom:40px;left:50%;transform:translateX(-50%);display:flex;gap:10px;background:rgba(240,240,240,.9);padding:15px;border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,.1);backdrop-filter:blur(10px);width:90%;max-width:400px}
    .nav-button{position:relative;background:linear-gradient(145deg,#4a90e2,#357abd);color:#fff;border:none;padding:10px 5px;border-radius:10px;font-size:14px;font-weight:bold;cursor:pointer;transition:all .1s ease;flex-grow:1;min-width:auto;text-transform:uppercase;letter-spacing:.5px;box-shadow:0 5px 0 #2c5aa0,0 8px 12px rgba(0,0,0,.15);transform:translateY(0);text-align:center}
    .nav-button:hover{transform:translateY(-1px);box-shadow:0 6px 0 #2c5aa0,0 10px 15px rgba(0,0,0,.2)}
    .nav-button:active{transform:translateY(2px);box-shadow:0 3px 0 #2c5aa0,0 5px 8px rgba(0,0,0,.15)}
    .nav-button span{display:block;text-shadow:0 1px 2px rgba(0,0,0,.3)}
    .spin-screen{position:fixed;inset:0;background:#f5f7fa;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s ease}
    .spin-screen.visible{opacity:1;pointer-events:auto}
    #wheelBox{position:relative;margin-bottom:25px}
    #wheelCanvas{border-radius:50%;box-shadow:0 0 0 8px #eee,0 8px 30px rgba(0,0,0,.3);background-color:#fff;border:1px solid #ccc}
    .arrow{position:absolute;top:-16px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-top:28px solid #ff3366;filter:drop-shadow(0 3px 2px rgba(0,0,0,.3));z-index:10}
    .spin-btn{background:#ff3366;color:#fff;border:none;padding:12px 35px;border-radius:30px;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 6px 0 #cc2950;transition:all .1s ease}
    .spin-btn:active{transform:translateY(3px);box-shadow:0 3px 0 #cc2950}
    .spin-result{margin-top:18px;font-size:18px;color:#333}
    .spin-back{margin-top:25px;background:#6c757d;color:#fff;border:none;padding:10px 25px;border-radius:8px;font-size:15px;font-weight:bold;cursor:pointer;box-shadow:0 4px 0 #5a6268}
    .spin-back:active{transform:translateY(2px);box-shadow:0 2px 0 #5a6268}
    .withdraw-screen{position:fixed;inset:0;background:#f5f7fa;display:flex;flex-direction:column;align-items:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .3s ease;overflow-y:auto}
    .withdraw-screen.visible{opacity:1;pointer-events:auto}
    .withdraw-header{text-align:center;margin-bottom:25px;width:100%;max-width:400px}
    .withdraw-title{font-size:28px;color:#4a90e2;font-weight:700;text-shadow:0 1px 1px rgba(0,0,0,.1)}
    .current-balance-info{font-size:16px;color:#555;margin-top:10px;font-weight:bold}
    .input-form-container{width:100%;max-width:400px;background:#fff;padding:25px;border-radius:15px;box-shadow:0 6px 20px rgba(0,0,0,.1);border:1px solid #ddd;margin-bottom:20px}
    .input-group{width:100%;margin-bottom:15px}
    .input-group label{display:block;margin-bottom:8px;font-size:14px;color:#555;font-weight:600}
    .input-group input{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:10px;font-size:16px;transition:border-color .3s ease,box-shadow .3s ease;outline:none}
    .input-group input:focus{border-color:#ff8c00;box-shadow:0 0 0 3px rgba(255,140,0,.2)}
    .withdraw-buttons{display:flex;gap:15px;margin-top:20px;justify-content:center}
    .withdraw-btn{background:linear-gradient(145deg,#28a745,#1e7e34);color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 5px 0 #1c6d32;transition:all .1s ease}
    .withdraw-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #1c6d32}
    .back-btn{background:linear-gradient(145deg,#6c757d,#5a6268);color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 5px 0 #4e555b;transition:all .1s ease}
    .back-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #4e555b}
    .note{margin-top:15px;font-size:13px;color:#777;max-width:400px;text-align:center;background:rgba(255,140,0,.1);padding:10px;border-radius:10px;border-left:5px solid #ff8c00}
    .history-section{width:100%;max-width:400px;margin-top:30px;padding:20px 0;border-top:1px solid #eee}
    .history-title{font-size:20px;color:#333;margin-bottom:15px;font-weight:700;text-align:center}
    .history-table{width:100%;border-collapse:collapse;font-size:14px}
    .history-table th,.history-table td{padding:10px;border-bottom:1px solid #eee;text-align:right}
    .history-table th{background-color:#f0f4f8;color:#4a90e2;font-weight:700}
    .history-table tr:last-child td{border-bottom:none}
    .status-pending{color:#ff8c00;font-weight:bold}
    .status-completed{color:#28a745;font-weight:bold}
    .no-records{text-align:center;color:#999;padding:20px}
    .invite-screen{position:fixed;inset:0;background:#f5f7fa;display:flex;flex-direction:column;align-items:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .3s ease;overflow-y:auto}
    .invite-screen.visible{opacity:1;pointer-events:auto}
    .invite-header{text-align:center;margin-bottom:25px;width:100%;max-width:400px}
    .invite-title{font-size:28px;color:#4a90e2;font-weight:700;text-shadow:0 1px 1px rgba(0,0,0,.1)}
    .referrals-count-info{font-size:18px;color:#333;margin-top:15px;font-weight:bold;padding:10px 15px;background:#e6f0ff;border-radius:10px;border:1px solid #cce0ff;box-shadow:0 2px 5px rgba(0,0,0,.05);width:100%}
    .invite-buttons{width:100%;margin-top:15px}
    .copy-link-btn{background:linear-gradient(145deg,#00bfff,#0077b3);color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 5px 0 #005a8d;transition:all .1s ease;width:100%}
    .copy-link-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #005a8d}
    #referralLinkInput{text-align:center;cursor:pointer;font-weight:500;color:#4a90e2;background:#f8f8f8;word-break:break-all;white-space:normal}
  </style>
</head>
<body>
  <!-- Loading -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-content">
      <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
      <div class="percentage" id="percentage">0%</div>
      <div class="loading-text" id="loadingText">Connecting to SHIB Network...</div>
    </div>
  </div>

  <!-- Main -->
  <div class="main-screen" id="mainScreen">
    <div class="balance" id="shibBalance">0 SHIB</div>
    <div class="progress-group-container">
      <div class="daily-progress-container">
        <div class="daily-progress-text">Ads today: <span id="adsCount">0</span> / 100</div>
        <div class="daily-progress-bar"><div class="daily-progress-fill" id="dailyProgressFill"></div></div>
      </div>
      <div class="spin-progress-container">
        <div class="spin-progress-text">Spins today: <span id="spinsCount">0</span> / 15</div>
        <div class="spin-progress-bar"><div class="spin-progress-fill" id="spinProgressFill"></div></div>
      </div>
    </div>
    <div class="user-circle" onclick="circleClick()"><img id="userImage" src="" alt=""><div class="placeholder">+</div></div>
    <div class="user-username" id="userName"></div>
    <div class="user-id" id="userId"></div>
    <div class="main-content"></div>
    <div class="button-container">
      <button class="nav-button" onclick="watchAds()"><span>Ads</span></button>
      <button class="nav-button" onclick="showWithdraw()"><span>Withdraw</span></button>
      <button class="nav-button" onclick="showSpin()"><span>Spin</span></button>
      <button class="nav-button" onclick="inviteFriends()"><span>Invite</span></button>
    </div>
  </div>

  <!-- Spin -->
  <div class="spin-screen" id="spinScreen">
    <div id="wheelBox"><div class="arrow"></div><canvas id="wheelCanvas" width="280" height="280"></canvas></div>
    <button class="spin-btn" id="spinBtn" onclick="startSpin()">SPIN</button>
    <div class="spin-result" id="spinResult"></div>
    <button class="spin-back" onclick="hideSpin()">Back</button>
  </div>

  <!-- Withdraw -->
  <div class="withdraw-screen" id="withdrawScreen">
    <div class="withdraw-header">
      <h2 class="withdraw-title">üí∞ Request SHIB Withdrawal</h2>
      <div class="current-balance-info">Your Balance: <span id="withdrawBalanceDisplay">0 SHIB</span></div>
    </div>
    <div class="input-form-container">
      <div class="input-group"><label>Binance User ID</label><input type="text" id="binanceId" placeholder="Enter your Binance ID"></div>
      <div class="input-group"><label>Amount in SHIB (Min 400)</label><input type="number" id="withdrawAmount" min="400" value="" placeholder=""></div>
      <div class="withdraw-buttons"><button class="withdraw-btn" onclick="confirmWithdraw()">Send Request</button></div>
    </div>
    <div class="note">‚ö†Ô∏è Important: The withdrawal will be processed manually within 24 hours. Ensure your Binance ID is correct.</div>
    <div class="history-section">
      <h3 class="history-title">Withdrawal History</h3>
      <div id="withdrawalHistoryContainer"></div>
    </div>
    <button class="back-btn" onclick="hideWithdraw()">Back to Main</button>
  </div>

  <!-- Invite -->
  <div class="invite-screen" id="inviteScreen">
    <div class="invite-header">
      <h2 class="invite-title">ü§ù Invite Friends & Earn SHIB</h2>
      <div class="referrals-count-info">Your Referrals: <span id="referralsCountDisplay">0</span></div>
    </div>
    <div class="input-form-container">
      <div class="input-group"><label>Your Referral Link</label><input type="text" id="referralLinkInput" readonly value="Generating Link..."></div>
      <div class="invite-buttons"><button class="copy-link-btn" onclick="copyReferralLink()">Copy Link</button></div>
    </div>
    <div class="note">üöÄ Share this link to invite new users. You will earn 5% of the revenue from every referral you bring through ads!</div>
    <button class="back-btn" onclick="hideInvite()">Back to Main</button>
  </div>

  <script src="https://ad.gigapub.tech/script?id=3459"></script>
  <script>
    /* ===== helper: ŸÉŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑÿßÿ™ ÿπÿ®ÿ± fetch ===== */
    function api(body){
      return fetch('/api',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
      .then(r=>{if(!r.ok)throw new Error('Server err');return r.json()});
    }

    /* ===== Loading ===== */
    const progressBar = document.getElementById('progressBar');
    const percentageTxt = document.getElementById('percentage');
    const loadingTxt = document.getElementById('loadingText');
    const loadingScreen = document.getElementById('loadingScreen');
    const mainScreen = document.getElementById('mainScreen');

    const loadingTexts = [
      "Initializing secure connection...","Loading blockchain data...","Verifying user session...",
      "Compiling reward data...","Preparing UI elements...","Optimizing assets...",
      "Finalizing application logic...","Ready to launch...","Entering the Matrix..."
    ];
    let currentProgress = 0;
    const loadingSpeed = 100;
    const loadingInterval = setInterval(()=>{
      const increment = Math.random()*3+1;
      currentProgress += increment;
      if(currentProgress>=100){
        currentProgress=100; clearInterval(loadingInterval);
        setTimeout(()=>{
          loadingScreen.classList.add('hidden');
          mainScreen.classList.add('visible');
          initDailyProgress();
        },500);
      }
      progressBar.style.width = currentProgress+'%';
      percentageTxt.textContent = Math.floor(currentProgress)+'%';
      const idx = Math.min(Math.floor((currentProgress/100)*loadingTexts.length),loadingTexts.length-1);
      loadingTxt.textContent = loadingTexts[idx];
    },loadingSpeed);

    document.addEventListener('DOMContentLoaded',()=>{
      const lc = document.querySelector('.loading-content');
      lc.style.opacity='0'; lc.style.transform='translateY(30px)';
      setTimeout(()=>{ lc.style.transition='all .8s ease-out'; lc.style.opacity='1'; lc.style.transform='translateY(0)'; },100);
    });

    /* ===== Telegram & Referral ===== */
    Telegram.WebApp.ready();
    let tgUser = null;
    if(Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user){
      tgUser = Telegram.WebApp.initDataUnsafe.user;
      const photoUrl = tgUser.photo_url;
      const userName = tgUser.first_name + (tgUser.last_name? ' '+tgUser.last_name:'');
      const userId = tgUser.id;
      const imgEl  = document.getElementById('userImage');
      const nameEl = document.getElementById('userName');
      const idEl   = document.getElementById('userId');
      const placeHolder = document.querySelector('.placeholder');
      if(photoUrl){
        imgEl.src = photoUrl;
        imgEl.style.display = 'block';
        placeHolder.style.display = 'none';
      }
      nameEl.textContent = userName;
      idEl.textContent   = 'ID: ' + userId;
    }

    function getRefParam() {
      let referrerId = null;
      const REF_PREFIX = 'ref_';
      if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.start_param) {
        const startParam = Telegram.WebApp.initDataUnsafe.start_param;
        if (startParam.startsWith(REF_PREFIX)) {
          referrerId = startParam.substring(REF_PREFIX.length);
        }
      } else if (!Telegram.WebApp.initDataUnsafe && window.location.search) {
        const urlParams = new URLSearchParams(window.location.search);
        let browserRef = urlParams.get('startapp');
        if (browserRef && browserRef.startsWith(REF_PREFIX)) {
          referrerId = browserRef.substring(REF_PREFIX.length);
        }
      }
      return referrerId;
    }
    let referrerId = getRefParam();

    function registerUser() {
      if (!tgUser) return;
      api({type:'register',user_id:tgUser.id,ref_by:referrerId}).catch(()=>{});
    }

    /* ===== Rewards & Limits ===== */
    const DAILY_MAX = 100;
    const REWARD_PER_AD = 3;
    const DAILY_MAX_SPINS = 15;
    const REFERRAL_COMMISSION_RATE = 0.05;
    const ADS_CLICK_COOLDOWN  = 1000;
    const SPIN_CLICK_COOLDOWN = 1000;

    let shibBalance = 0;
    let adsWatchedToday = 0;
    let spinsToday = 0;
    let withdrawalHistory = [];
    let referralsCount = 0;

    function initDailyProgress(){
      registerUser();
      updateUI();
    }

    function updateUI(){
      document.getElementById('shibBalance').textContent = shibBalance.toLocaleString() + ' SHIB';
      document.getElementById('withdrawBalanceDisplay').textContent = shibBalance.toLocaleString() + ' SHIB';
      document.getElementById('adsCount').textContent = adsWatchedToday;
      const adsPercent = Math.min((adsWatchedToday / DAILY_MAX) * 100, 100);
      document.getElementById('dailyProgressFill').style.width = adsPercent + '%';
      document.getElementById('spinsCount').textContent = spinsToday;
      const spinsPercent = Math.min((spinsToday / DAILY_MAX_SPINS) * 100, 100);
      document.getElementById('spinProgressFill').style.width = spinsPercent + '%';
      document.getElementById('referralsCountDisplay').textContent = referralsCount.toLocaleString();
      const spinBtn = document.getElementById('spinBtn');
      if (spinsToday >= DAILY_MAX_SPINS) {
        spinBtn.disabled = true;
        spinBtn.textContent = `Limit Reached (${spinsToday}/${DAILY_MAX_SPINS})`;
      } else if (!spinning) {
        spinBtn.disabled = false;
        spinBtn.textContent = 'SPIN';
      }
    }

    /* ===== Ads Action via fetch ===== */
    function watchAds(){
      const now = Date.now();
      const lastClick = parseInt(sessionStorage.getItem('lastAdClickTime') || 0);
      if (now - lastClick < ADS_CLICK_COOLDOWN) return;
      sessionStorage.setItem('lastAdClickTime', now);
      if(adsWatchedToday >= DAILY_MAX){
        alert('‚úÖ You have reached the daily limit of 100 ads. Come back tomorrow!');
        return;
      }
      window.showGiga()
        .then(()=>{
          // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ£ŸÉÿ¥ŸÜ ÿ•ŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ
          api({type:'watchAd',user_id:tgUser.id,reward:REWARD_PER_AD}).then(()=>{
            shibBalance += REWARD_PER_AD;
            adsWatchedToday += 1;
            if (referrerId && tgUser) {
              const commissionAmount = REWARD_PER_AD * REFERRAL_COMMISSION_RATE;
              api({type:'commission',referrer_id:referrerId,referee_id:tgUser.id,amount:commissionAmount,source_reward:REWARD_PER_AD}).catch(()=>{});
            }
            updateUI();
            if(adsWatchedToday >= DAILY_MAX) alert('üéâ Great! You completed 100 ads today.');
          }).catch(()=>Telegram.WebApp.showAlert('‚ùå Failed to record ad reward.'));
        })
        .catch(()=>Telegram.WebApp.showAlert('‚ùå Failed to load ad. Please try again.'));
    }

    function circleClick(){}

    /* ===== Spin Wheel ===== */
    const sectors = [5,10,15,20,5];
    const colors = ['#f73859','#38e3e7','#f73859','#ffd60a','#38e3e7'];
    const canvas = document.getElementById('wheelCanvas');
    const ctx = canvas.getContext('2d');
    const spinResult = document.getElementById('spinResult');
    const spinBtn = document.getElementById('spinBtn');
    let spinning = false;
    let currentAngle = 0;

    function drawWheel(){
      const centerX = canvas.width/2, centerY = canvas.height/2, radius = 130, arc = 2*Math.PI/sectors.length;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      sectors.forEach((val,i)=>{
        const start = i*arc;
        ctx.beginPath(); ctx.fillStyle = colors[i]; ctx.moveTo(centerX,centerY); ctx.arc(centerX,centerY,radius,start,start+arc); ctx.closePath(); ctx.fill();
        ctx.beginPath(); ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.moveTo(centerX,centerY); ctx.arc(centerX,centerY,radius,start,start+arc); ctx.closePath(); ctx.stroke();
        ctx.save(); ctx.fillStyle='#111'; ctx.font='bold 20px Arial'; ctx.shadowColor='rgba(255,255,255,.5)'; ctx.shadowBlur=4;
        ctx.translate(centerX,centerY); ctx.rotate(start+arc/2); ctx.textAlign='center'; ctx.fillText(val+'',radius*.65,5); ctx.restore();
      });
      ctx.beginPath(); ctx.fillStyle='#fff'; ctx.arc(centerX,centerY,15,0,2*Math.PI); ctx.fill(); ctx.strokeStyle='#333'; ctx.lineWidth=3; ctx.stroke();
    }
    drawWheel();

    /* ===== Spin Action via fetch ===== */
    function startSpin(){
      if(spinning) return;
      const now = Date.now();
      const lastClick = parseInt(sessionStorage.getItem('lastSpinClickTime')||0);
      if(now-lastClick < SPIN_CLICK_COOLDOWN) return;
      sessionStorage.setItem('lastSpinClickTime',now);
      if(spinsToday>=DAILY_MAX_SPINS){ alert('‚ö†Ô∏è ŸÑŸÇÿØ ŸàÿµŸÑÿ™ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑŸÑÿØŸàÿ±ÿßŸÜ ÿßŸÑŸäŸàŸÖŸä (15 ŸÖÿ±ÿ©). Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿπŸàÿØÿ© ÿ∫ÿØÿßŸã!'); spinBtn.disabled=true; return; }
      window.showGiga()
        .then(()=>{
          // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ£ŸÉÿ¥ŸÜ ÿ•ŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ
          api({type:'spin',user_id:tgUser.id}).then(()=>{
            spinsToday+=1; updateUI(); spinning=true; spinBtn.disabled=true; spinResult.textContent='';
            const spins = 5+Math.random()*5, finalAngle = Math.random()*2*Math.PI, totalAngle = spins*2*Math.PI+finalAngle;
            currentAngle += totalAngle;
            canvas.style.transition='transform 4s cubic-bezier(0.22,0,0.2,1)'; canvas.style.transform=`rotate(${currentAngle}rad)`;
            setTimeout(()=>{
              canvas.style.transition='none';
              const radPerSector = 2*Math.PI/sectors.length, normalizedAngle = currentAngle%(2*Math.PI), angleFromArrow = normalizedAngle+(Math.PI/2);
              let idx = sectors.length-1-Math.floor(angleFromArrow/radPerSector); if(idx<0) idx+=sectors.length;
              const prize = sectors[idx]; shibBalance+=prize; spinResult.textContent=`üéâ You won ${prize} SHIB!`;
              spinning=false; updateUI();
              // ÿ•ÿ±ÿ≥ÿßŸÑ ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿØŸàÿ±ÿßŸÜ ÿ•ŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ
              api({type:'spinResult',user_id:tgUser.id,prize:prize}).catch(()=>{});
            },4000);
          }).catch(()=>Telegram.WebApp.showAlert('‚ùå Failed to record spin.'));
        })
        .catch(()=>Telegram.WebApp.showAlert('‚ùå Failed to load ad. Spin was not counted. Please try again.'));
    }

    /* ===== Navigation ===== */
    function showSpin(){ mainScreen.classList.remove('visible'); document.getElementById('spinScreen').classList.add('visible'); updateUI(); }
    function hideSpin(){ document.getElementById('spinScreen').classList.remove('visible'); mainScreen.classList.add('visible'); }
    function showWithdraw(){ mainScreen.classList.remove('visible'); document.getElementById('withdrawScreen').classList.add('visible'); updateUI(); displayWithdrawals(); }
    function hideWithdraw(){ document.getElementById('withdrawScreen').classList.remove('visible'); mainScreen.classList.add('visible'); }
    function displayWithdrawals(){
      const container = document.getElementById('withdrawalHistoryContainer');
      if(withdrawalHistory.length===0){ container.innerHTML='<div class="no-records">No withdrawal requests found.</div>'; return; }
      let tableHTML='<table class="history-table"><thead><tr><th>Date</th><th>Amount (SHIB)</th><th>Status</th></tr></thead><tbody>';
      withdrawalHistory.forEach(r=>{
        const statusClass=r.status==='Pending'?'status-pending':'status-completed';
        tableHTML+=`<tr><td>${r.date}</td><td>${r.amount.toLocaleString()}</td><td><span class="${statusClass}">${r.status}</span></td></tr>`;
      });
      tableHTML+='</tbody></table>'; container.innerHTML=tableHTML;
    }
    function confirmWithdraw(){
      const binanceId = document.getElementById('binanceId').value.trim();
      const amount = parseInt(document.getElementById('withdrawAmount').value);
      if(!binanceId||binanceId.length<8){alert('Please enter a valid Binance User ID (min 8 digits).');return;}
      if(isNaN(amount)||amount<400){alert('Minimum withdrawal is 400 SHIB.');return;}
      if(amount>shibBalance){alert('Insufficient balance. Your current balance is '+shibBalance.toLocaleString()+' SHIB.');return;}
      api({type:'withdraw',user_id:tgUser.id,binanceId,amount}).catch(()=>{});
      shibBalance-=amount;
      const today=new Date(),dateString=today.getFullYear()+'-'+(today.getMonth()+1).toString().padStart(2,'0')+'-'+today.getDate().toString().padStart(2,'0');
      withdrawalHistory.push({id:withdrawalHistory.length?withdrawalHistory[withdrawalHistory.length-1].id+1:1,amount,date:dateString,status:'Pending'});
      updateUI(); displayWithdrawals();
      alert('‚úÖ Withdrawal request sent successfully!\n\nBinance ID: '+binanceId+'\nAmount: '+amount.toLocaleString()+' SHIB\n\nThe amount will be transferred to your account within 24 hours.');
    }

    /* ===== Invite ===== */
    function inviteFriends(){
      mainScreen.classList.remove('visible');
      document.getElementById('inviteScreen').classList.add('visible');
      generateReferralLink();
      updateUI();
    }
    function hideInvite(){
      document.getElementById('inviteScreen').classList.remove('visible');
      mainScreen.classList.add('visible');
    }
    function generateReferralLink(){
      const referralLinkInput = document.getElementById('referralLinkInput');
      if(!tgUser){ referralLinkInput.value='User data not available.'; return; }
      const userId = tgUser.id;
      const botPath="Game_win_usdtBot/earn";
      const inviteLink=`https://t.me/${botPath}?startapp=ref_${userId}`;
      referralLinkInput.value=inviteLink;
    }
    function copyReferralLink(){
      const inviteLink=document.getElementById('referralLinkInput').value;
      if(inviteLink==='User data not available.'||inviteLink==='Generating Link...'){ Telegram.WebApp.showAlert('Cannot copy: Referral link is not ready.'); return; }
      navigator.clipboard.writeText(inviteLink).then(()=>{
        Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        Telegram.WebApp.showAlert('‚úÖ Referral link copied to clipboard!');
      }).catch(()=>Telegram.WebApp.showAlert('‚ùå Failed to copy link. Please try again.'));
    }
  </script>
</body>
</html>
